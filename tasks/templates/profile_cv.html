{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Hoja de Vida | {{ perfil.nombres }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb; 
            --secondary-color: #1e293b;
            --bg-color: #f8fafc;
            --sidebar-width: 280px;
            --accent-color: #00f260;
            --garage-color: #ff9f43; 
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--secondary-color); overflow-x: hidden; margin: 0; }

        /* --- BARRA LATERAL --- */
        .sidebar { width: var(--sidebar-width); position: fixed; top: 0; bottom: 0; left: 0; background: white; border-right: 1px solid #e2e8f0; padding: 30px 20px; z-index: 1000; text-align: center; box-shadow: 2px 0 10px rgba(0,0,0,0.03); overflow-y: auto; }
        .profile-photo-container { width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 4px solid white; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2); }
        .profile-photo { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 1.2rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 5px; }
        .profile-title { font-size: 0.9rem; color: #64748b; margin-bottom: 30px; }
        .nav-pills .nav-link { text-align: left; color: #64748b; font-weight: 500; padding: 12px 20px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .nav-pills .nav-link:hover { background-color: #eff6ff; color: var(--primary-color); transform: translateX(5px); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .nav-pills .nav-link.active i { color: white; }
        .nav-pills .nav-link i { width: 25px; color: var(--primary-color); }

        /* --- CONTENIDO PRINCIPAL --- */
        .main-content { margin-left: var(--sidebar-width); padding: 40px 60px; min-height: 100vh; }
        section { display: none; animation: fadeIn 0.4s ease-in-out; }
        section.active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TARJETAS --- */
        .section-header { margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        .section-header h2 { font-weight: 700; color: #ec4899; font-size: 1.8rem; }
        .info-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; margin-bottom: 30px; }
        .info-label { font-weight: 700; color: #1e293b; display: block; }
        .info-value { color: #64748b; }
        .icon-header { display: flex; align-items: center; margin-bottom: 20px; color: var(--primary-color); font-weight: 600; font-size: 1.1rem; }
        .icon-header i { margin-right: 10px; font-size: 1.3rem; }
        
        /* Recursos y Habilidades */
        .recurso-item { border-left: 4px solid var(--accent-color); background: #f8f9fa; padding: 15px 20px; margin-bottom: 15px; border-radius: 0 10px 10px 0; transition: 0.3s; }
        .recurso-titulo { font-weight: 700; color: var(--secondary-color); margin-bottom: 5px; display: block; }
        
        .tech-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .tech-badge { 
            background: #eff6ff; color: var(--primary-color); 
            padding: 8px 16px; border-radius: 20px; font-weight: 600; 
            font-size: 0.9rem; border: 1px solid #dbeafe; 
            transition: all 0.3s ease; cursor: pointer; position: relative; z-index: 50;
        }
        .tech-badge:hover { background: var(--primary-color); color: white; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); z-index: 51; }

        /* --- ELEMENTOS OCULTOS QUE SOLO SALEN EN PDF --- */
        .pdf-visible-content { display: none; } 

        /* --- BOTONES SUPERIORES --- */
        .top-buttons { position: fixed; top: 30px; right: 30px; z-index: 1001; display: flex; gap: 15px; }
        .btn-float { background: white; color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 50px; padding: 10px 25px; font-weight: 600; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-float:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-pdf { background: var(--primary-color); color: white; border: none; }
        .btn-pdf:hover { background: #1d4ed8; color: white; }
        .btn-garage { background: var(--garage-color); color: white; border: none; border-radius: 50px; padding: 10px 25px; font-weight: 700; display: flex; align-items: center; gap: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4); transition: 0.3s; text-decoration: none;}

        /* --- GARAGE --- */
        .product-card { border: 1px solid #eee; border-radius: 15px; padding: 15px; text-align: center; transition: 0.3s; height: 100%; background: #fff; }
        .product-img { height: 120px; object-fit: contain; margin-bottom: 15px; }
        .product-price { color: var(--garage-color); font-weight: 800; font-size: 1.2rem; margin: 10px 0; }
        
        @media (max-width: 991px) { .sidebar { width: 100%; position: relative; height: auto; } .main-content { margin-left: 0; padding: 20px; } .top-buttons { position: relative; top: 0; right: 0; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;} }
        
        /* ========================================= */
        /* CSS LIMPIO Y CORREGIDO PARA PDF          */
        /* ========================================= */
        .generating-pdf * {
            animation: none !important; transition: none !important; opacity: 1 !important; 
            text-shadow: none !important; box-shadow: none !important;
        }
        .generating-pdf body { background-color: #ffffff !important; -webkit-print-color-adjust: exact; }
        
        .generating-pdf .sidebar { position: absolute; left: 0; top: 0; height: 100%; background: #f8f9fa !important; border-right: 1px solid #ccc !important; }
        .generating-pdf .main-content { margin-left: 280px !important; padding: 20px !important; background: white !important; }
        
        .generating-pdf .top-buttons, 
        .generating-pdf button.tech-badge,
        .generating-pdf .btn-ver-cert,     
        .generating-pdf .btn-garage { display: none !important; }

        .generating-pdf .pdf-visible-content { 
            display: block !important; 
            margin-top: 10px; padding: 10px;
            border: 1px solid #eee; background: #fafafa; border-radius: 8px;
        }

        .generating-pdf .cert-img-pdf {
            width: 100%; max-width: 300px; 
            height: auto; display: block; margin: 10px auto;
            border: 5px solid #fff; box-shadow: 0 0 5px rgba(0,0,0,0.2) !important;
        }

        .generating-pdf .skill-item-pdf {
            margin-bottom: 15px; border-left: 4px solid var(--primary-color); padding-left: 15px;
        }
        .generating-pdf .skill-title-pdf { font-weight: bold; color: var(--primary-color); font-size: 1.1rem; }
        .generating-pdf .skill-desc-pdf { color: #333; font-size: 0.95rem; text-align: justify; }

        .generating-pdf h2 { color: #ec4899 !important; }
        .generating-pdf h5, .generating-pdf .fw-bold { color: #000 !important; }
        .generating-pdf p, .generating-pdf small { color: #222 !important; }
    </style>
</head>
<body id="body-cv">

    <div class="top-buttons">
        <button class="btn-garage" data-bs-toggle="modal" data-bs-target="#garageModal">
            <i class="fas fa-shopping-cart"></i> Garage
        </button>
        <a href="/" class="btn-float"><i class="fas fa-home"></i> Inicio</a>
        {% if user.is_authenticated %}
            <a href="/logout/" class="btn-float text-danger" style="border-color: #dc3545; color: #dc3545;"><i class="fas fa-sign-out-alt"></i> Salir</a>
            <a href="/admin/" class="btn-float" style="border-color: #198754; color: #198754;"><i class="fas fa-cog"></i> Editar</a>
        {% else %}
            <a href="/signin/" class="btn-float"><i class="fas fa-user"></i> Login</a>
        {% endif %}
        <a href="#" onclick="generarPDF()" class="btn-float btn-pdf"><i class="fas fa-file-pdf"></i> PDF</a>
    </div>

    <nav class="sidebar">
        <div class="profile-photo-container">
            <img src="{% static 'perfil_andy.jpeg' %}" alt="Foto" class="profile-photo" onerror="this.src='https://via.placeholder.com/150'">
        </div>
        <div class="profile-name">{{ perfil.nombres }} {{ perfil.apellidos }}</div>
        <div class="profile-title">Estudiante de TI</div>
        <hr class="my-4" style="opacity: 0.1;">
        <div class="nav flex-column nav-pills">
            <a class="nav-link active" onclick="mostrarSeccion('inicio', this)"><i class="fas fa-user"></i> Inicio</a>
            <a class="nav-link" onclick="mostrarSeccion('recursos', this)"><i class="fas fa-book-reader"></i> Recursos Académicos</a>
            <a class="nav-link" onclick="mostrarSeccion('experiencia', this)"><i class="fas fa-briefcase"></i> Experiencia</a>
            <a class="nav-link" onclick="mostrarSeccion('educacion', this)"><i class="fas fa-graduation-cap"></i> Educación</a>
            <a class="nav-link" onclick="mostrarSeccion('reconocimientos', this)"><i class="fas fa-award"></i> Reconocimientos</a>
            <a class="nav-link" onclick="mostrarSeccion('habilidades', this)"><i class="fas fa-star"></i> Habilidades</a>
        </div>
    </nav>

    <main class="main-content">
        <section id="inicio" class="active-section">
            <div class="section-header"><h2>Información Personal</h2></div>
            <div class="info-card">
                <div class="icon-header"><i class="fas fa-user-circle"></i> Perfil Profesional</div>
                <p class="text-muted mb-0" style="text-align: justify; line-height: 1.8;">
                    {{ perfil.perfil_profesional|default:"Estudiante de la carrera de Tecnología de la Información..." }}
                </p>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="info-card h-100">
                        <div class="icon-header"><i class="fas fa-id-card"></i> Datos</div>
                        <div class="mb-3"><span class="info-label">Cédula:</span> <span class="info-value">{{ perfil.numerocedula }}</span></div>
                        <div class="mb-3"><span class="info-label">Nacionalidad:</span> <span class="info-value">{{ perfil.nacionalidad|default:"Ecuatoriana" }}</span></div>
                        <div class="mb-3"><span class="info-label">Nacimiento:</span> <span class="info-value">15 Agosto 2005</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-card h-100">
                        <div class="icon-header"><i class="fas fa-envelope"></i> Contacto</div>
                        <div class="mb-3"><span class="info-label">Teléfono:</span> <span class="info-value">{{ perfil.telefonofijo }}</span></div>
                        <div class="mb-3"><span class="info-label">Email:</span> <span class="info-value">andy@ejemplo.com</span></div>
                        <div class="mb-3"><span class="info-label">Portafolio Web:</span> 
                            <a href="https://github.com/andyzz10/" target="_blank" class="text-primary text-decoration-none fw-bold">Visitar <i class="fas fa-external-link-alt small"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="recursos">
            <div class="section-header"><h2>Recursos Académicos</h2></div>
            <div class="info-card">
                {% for rec in recursos %}
                <div class="recurso-item">
                    <span class="recurso-titulo">
                        <i class="{{ rec.icono }} me-2 text-primary"></i> {{ rec.titulo }}
                    </span>
                    {{ rec.descripcion }}
                </div>
                {% empty %}
                <p class="text-center text-muted">No hay recursos. ¡Agrégalos desde el Admin!</p>
                {% endfor %}
            </div>
        </section>

        <section id="experiencia">
            <div class="section-header"><h2>Experiencia Laboral</h2></div>
            <div class="info-card">
                {% for exp in experiencias %}
                <div class="exp-item border-start border-3 border-primary ps-3 mb-4">
                    <h5 class="fw-bold">{{ exp.cargodesempenado }}</h5>
                    <div class="text-primary mb-1">{{ exp.nombrempresa }}</div>
                    <small class="text-muted d-block mb-2"><i class="far fa-calendar-alt"></i> {{ exp.fecha_inicio }}</small>
                    <p class="mb-0 text-muted">{{ exp.logros }}</p>
                </div>
                {% empty %}
                <p class="text-center text-muted">No hay experiencia registrada.</p>
                {% endfor %}
            </div>
        </section>

        <section id="educacion">
            <div class="section-header"><h2>Formación Académica</h2></div>
            <div class="info-card">
                {% for edu in educacion %}
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-primary text-white rounded p-3 me-3"><i class="fas fa-graduation-cap fa-lg"></i></div>
                    <div>
                        <h5 class="mb-0 fw-bold">{{ edu.titulo }}</h5>
                        <span class="text-muted d-block">{{ edu.institucion }}</span>
                        <small class="text-secondary">{{ edu.fecha_inicio|date:"Y" }} - {% if edu.fecha_fin %}{{ edu.fecha_fin|date:"Y" }}{% else %}Presente{% endif %}</small>
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-muted">No hay educación registrada.</p>
                {% endfor %}
            </div>
        </section>

        <section id="reconocimientos">
            <div class="section-header"><h2>Cursos y Certificaciones</h2></div>
            <div class="row">
                {% for rec in reconocimientos %}
                <div class="col-md-6 mb-3">
                    <div class="info-card h-100 position-relative">
                        <div class="icon-header text-warning"><i class="fas fa-award"></i> Certificación</div>
                        <h5 class="fw-bold">{{ rec.titulo }}</h5>
                        <p class="text-muted">{{ rec.institucion }}</p>
                        
                        {% if rec.imagen %}
                        <button class="btn btn-outline-primary btn-sm btn-ver-cert mt-2" 
                                type="button" data-bs-toggle="modal" data-bs-target="#certificadoModal" 
                                data-bs-img="{{ rec.imagen.url }}">
                            <i class="fas fa-eye"></i> Ver Credencial
                        </button>
                        
                        <div class="pdf-visible-content">
                            <img src="{{ rec.imagen.url }}" class="cert-img-pdf" alt="Certificado" 
                                 onerror="this.src='{% static 'cert_titulo.jpg' %}'"> 
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center text-muted"><p>No hay reconocimientos.</p></div>
                {% endfor %}
            </div>
        </section>

        <section id="habilidades">
            <div class="section-header"><h2>Stack Tecnológico</h2></div>
            <div class="info-card">
                <div class="icon-header"><i class="fas fa-rocket"></i> Competencias Clave</div>
                
                <div class="tech-container">
                    {% for hab in habilidades %}
                    
                    <button class="tech-badge border-0" type="button" data-bs-toggle="modal" data-bs-target="#skillModal"
                            data-bs-nombre="{{ hab.nombre|escape }}"
                            data-bs-nivel="{{ hab.porcentaje }}"
                            data-bs-desc="{{ hab.descripcion|default:'Sin descripción.'|escape }}">
                        <i class="fas fa-check-circle"></i> {{ hab.nombre }}
                    </button>

                    <div class="pdf-visible-content skill-item-pdf">
                        <div class="skill-title-pdf"><i class="fas fa-check"></i> {{ hab.nombre }} ({{ hab.porcentaje }}%)</div>
                        <div class="skill-desc-pdf">{{ hab.descripcion|default:"Manejo competente." }}</div>
                    </div>

                    {% empty %}
                    <p class="text-muted">No hay habilidades registradas.</p>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <div class="modal fade" id="certificadoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body text-center position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                    <img id="imagenModal" src="" class="img-fluid rounded shadow-lg" alt="Certificado">
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="garageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header text-white" style="background: var(--garage-color);">
                    <h5 class="modal-title fw-bold"><i class="fas fa-store"></i> Garage de {{ perfil.nombres }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light p-4">
                    <div class="row">
                        {% for prod in productos %}
                        <div class="col-md-4 mb-4">
                            <div class="product-card">
                                {% if prod.imagen %}
                                    <img src="{{ prod.imagen.url }}" class="product-img" alt="{{ prod.nombre }}" 
                                         onerror="this.src='{% static 'ventilador.jpg' %}'">
                                {% else %}
                                    <img src="{% static 'ventilador.jpg' %}" class="product-img" alt="Sin foto">
                                {% endif %}
                                <h5 class="fw-bold text-dark">{{ prod.nombre }}</h5>
                                <p class="text-muted small">{{ prod.descripcion|truncatechars:50 }}</p>
                                <div class="product-price">${{ prod.precio }}</div>
                                <button class="btn btn-warning w-100 fw-bold rounded-pill text-white"><i class="fas fa-cart-plus"></i> Comprar</button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5"><h4 class="text-muted">El garage está vacío. Agrégale productos en Django Admin.</h4></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="skillModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="skillTitle">...</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <h6 class="text-muted mb-3">Nivel de Dominio</h6>
                    <div class="progress mb-4" style="height: 25px; border-radius: 15px; background-color: #e9ecef;">
                        <div id="skillBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <h6 class="text-muted mb-2">Contexto de Experiencia</h6>
                    <p id="skillDesc" class="lead text-dark" style="font-size: 1.1rem;">...</p>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // Navegación
            window.mostrarSeccion = function(idSeccion, elementoBtn) {
                document.querySelectorAll('section').forEach(sec => sec.classList.remove('active-section'));
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                
                const seccion = document.getElementById(idSeccion);
                if(seccion) seccion.classList.add('active-section');
                if(elementoBtn) elementoBtn.classList.add('active');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // Modales
            const certModal = document.getElementById('certificadoModal');
            if (certModal) {
                certModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const imagenSrc = button.getAttribute('data-bs-img');
                    const modalImg = certModal.querySelector('#imagenModal');
                    if(modalImg) modalImg.src = imagenSrc;
                });
            }

            const skillModal = document.getElementById('skillModal');
            if (skillModal) {
                skillModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const nombre = button.getAttribute('data-bs-nombre');
                    const nivel = button.getAttribute('data-bs-nivel');
                    const desc = button.getAttribute('data-bs-desc');

                    skillModal.querySelector('#skillTitle').textContent = nombre;
                    skillModal.querySelector('#skillDesc').textContent = desc;
                    const bar = skillModal.querySelector('#skillBar');
                    bar.style.width = nivel + '%';
                    bar.textContent = nivel + '%';
                    
                    bar.className = 'progress-bar progress-bar-striped progress-bar-animated';
                    if(nivel >= 80) bar.classList.add('bg-success');
                    else if(nivel >= 50) bar.classList.add('bg-primary');
                    else bar.classList.add('bg-warning');
                });
            }

            // PDF
            window.generarPDF = function() {
                const element = document.getElementById('body-cv');
                const btn = document.querySelector('.btn-pdf');
                if(!btn) return; 
                
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
                document.body.classList.add('generating-pdf');

                const opt = {
                    margin: 0,
                    filename: 'CV_Andy_Zambrano.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                const safetyTimer = setTimeout(() => {
                    document.body.classList.remove('generating-pdf');
                    btn.innerHTML = originalText;
                    alert("El PDF se tardó. Si faltan imágenes, Django las reemplazará para que no falle. Intenta de nuevo.");
                }, 5000);

                setTimeout(() => {
                    html2pdf().set(opt).from(element).save()
                    .then(() => {
                        clearTimeout(safetyTimer);
                        document.body.classList.remove('generating-pdf');
                        btn.innerHTML = originalText;
                    })
                    .catch((err) => {
                        clearTimeout(safetyTimer);
                        console.error("Error PDF:", err);
                        document.body.classList.remove('generating-pdf');
                        btn.innerHTML = originalText;
                    });
                }, 1000); 
            };
        });
    </script>
</body>
</html>