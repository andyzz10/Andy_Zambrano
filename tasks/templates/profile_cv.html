{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoja de Vida | {{ perfil.nombres }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb; 
            --secondary-color: #1e293b;
            --bg-color: #f8fafc;
            --sidebar-width: 280px;
            --accent-color: #00f260;
            --garage-color: #ff9f43; 
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--secondary-color); overflow-x: hidden; margin: 0; }

        .sidebar { width: var(--sidebar-width); position: fixed; top: 0; bottom: 0; left: 0; background: white; border-right: 1px solid #e2e8f0; padding: 30px 20px; z-index: 1000; text-align: center; box-shadow: 2px 0 10px rgba(0,0,0,0.03); overflow-y: auto; display: flex; flex-direction: column; }
        
        .profile-photo-container { width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 4px solid white; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.2); background: #eee; }
        .profile-photo { width: 100%; height: 100%; object-fit: cover; }
        
        .profile-name { font-size: 1.2rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 5px; }
        .profile-title { font-size: 0.9rem; color: #64748b; margin-bottom: 30px; }
        .nav-pills .nav-link { text-align: left; color: #64748b; font-weight: 500; padding: 12px 20px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .nav-pills .nav-link:hover { background-color: #eff6ff; color: var(--primary-color); transform: translateX(5px); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .nav-pills .nav-link.active i { color: white; }
        .nav-pills .nav-link i { width: 25px; color: var(--primary-color); }

        .btn-config-menu { margin-top: auto; border: 1px solid #dee2e6; background: transparent; color: #6c757d; border-radius: 50px; padding: 10px; font-size: 0.9rem; transition: 0.3s; width: 100%; text-align: center; }
        .btn-config-menu:hover { background: #f8f9fa; color: var(--primary-color); border-color: var(--primary-color); }

        .main-content { margin-left: var(--sidebar-width); padding: 40px 60px; min-height: 100vh; }
        section { display: none; animation: fadeIn 0.4s ease-in-out; }
        section.active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-header { margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        .section-header h2 { font-weight: 700; color: #ec4899; font-size: 1.8rem; }
        .info-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #f1f5f9; margin-bottom: 30px; }
        .info-label { font-weight: 700; color: #1e293b; display: block; }
        .info-value { color: #64748b; }
        .icon-header { display: flex; align-items: center; margin-bottom: 20px; color: var(--primary-color); font-weight: 600; font-size: 1.1rem; }
        .icon-header i { margin-right: 10px; font-size: 1.3rem; }
        
        .recurso-item { border-left: 4px solid var(--accent-color); background: #f8f9fa; padding: 15px 20px; margin-bottom: 15px; border-radius: 0 10px 10px 0; transition: 0.3s; }
        .recurso-titulo { font-weight: 700; color: var(--secondary-color); margin-bottom: 5px; display: block; }
        
        .pdf-visible-content { display: none; } 

        .top-buttons { position: fixed; top: 30px; right: 30px; z-index: 1001; display: flex; gap: 15px; }
        .btn-float { background: white; color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 50px; padding: 10px 25px; font-weight: 600; text-decoration: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-float:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-pdf { background: var(--primary-color); color: white; border: none; cursor: pointer;}
        .btn-pdf:hover { background: #1d4ed8; color: white; }
        .btn-garage { background: var(--garage-color); color: white; border: none; border-radius: 50px; padding: 10px 25px; font-weight: 700; display: flex; align-items: center; gap: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4); transition: 0.3s; text-decoration: none;}

        .product-card { border: 1px solid #eee; border-radius: 15px; padding: 15px; text-align: center; transition: 0.3s; height: 100%; background: #fff; }
        .product-img { height: 120px; object-fit: contain; margin-bottom: 15px; }
        .product-price { color: var(--garage-color); font-weight: 800; font-size: 1.2rem; margin: 10px 0; }
        .badge-estado { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .bg-bueno { background: #28a745; color: white; }
        .bg-regular { background: #ffc107; color: black; }
        
        @media (max-width: 991px) { .sidebar { width: 100%; position: relative; height: auto; display: block; } .main-content { margin-left: 0; padding: 20px; } .top-buttons { position: relative; top: 0; right: 0; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;} }
        
        .generating-pdf * { animation: none !important; transition: none !important; opacity: 1 !important; text-shadow: none !important; box-shadow: none !important; }
        .generating-pdf body { background-color: #ffffff !important; -webkit-print-color-adjust: exact; }
        .generating-pdf .sidebar { position: absolute; left: 0; top: 0; height: 100%; background: #f8f9fa !important; border-right: 1px solid #ccc !important; }
        .generating-pdf .main-content { margin-left: 280px !important; padding: 20px !important; background: white !important; }
        .generating-pdf .top-buttons, .generating-pdf .btn-config-menu { display: none !important; }
        .generating-pdf .pdf-visible-content { display: block !important; margin-top: 10px; padding: 10px; border: 1px solid #eee; background: #fafafa; border-radius: 8px; }
        .generating-pdf .cert-img-pdf { width: 100%; max-width: 300px; height: auto; display: block; margin: 10px auto; border: 5px solid #fff; box-shadow: 0 0 5px rgba(0,0,0,0.2) !important; }
        .generating-pdf h2 { color: #ec4899 !important; }
        
        .d-none-web { display: none !important; }
        .generating-pdf .d-none-pdf { display: none !important; } 
    </style>
</head>
<body id="body-cv">

    <div class="top-buttons">
        {% if perfil.mostrar_garage %}
        <button id="btnGarageTop" class="btn-garage" data-bs-toggle="modal" data-bs-target="#garageModal">
            <i class="fas fa-shopping-cart"></i> Garage
        </button>
        {% endif %}
        
        <a href="/" class="btn-float"><i class="fas fa-home"></i> Inicio</a>
        {% if user.is_authenticated %}
            <a href="/logout/" class="btn-float text-danger" style="border-color: #dc3545; color: #dc3545;"><i class="fas fa-sign-out-alt"></i> Salir</a>
            <a href="/admin/" class="btn-float" style="border-color: #198754; color: #198754;"><i class="fas fa-cog"></i> Editar</a>
        {% else %}
            <a href="/signin/" class="btn-float"><i class="fas fa-user"></i> Login</a>
        {% endif %}
        <button class="btn-float btn-pdf" data-bs-toggle="modal" data-bs-target="#pdfConfigModal">
            <i class="fas fa-file-pdf"></i> PDF
        </button>
    </div>

    <nav class="sidebar">
        <div class="profile-photo-container">
            <img src="{% static 'perfil_andy.jpeg' %}" alt="{{ perfil.nombres }}" class="profile-photo">
        </div>
        
        <div class="profile-name">{{ perfil.nombres }} {{ perfil.apellidos }}</div>
        <div class="profile-title">Estudiante de TI</div>
        <hr class="my-4" style="opacity: 0.1;">
        
        <div class="nav flex-column nav-pills">
            <a class="nav-link active" onclick="mostrarSeccion('inicio', this)"><i class="fas fa-user"></i> Inicio</a>
            
            {% if perfil.mostrar_productos_academicos %}
            <span id="nav-productos">
                <a class="nav-link" onclick="mostrarSeccion('productos_academicos', this)"><i class="fas fa-book-reader"></i> Productos Académicos</a>
            </span>
            {% endif %}

            {% if perfil.mostrar_experiencia %}
            <span id="nav-experiencia">
                <a class="nav-link" onclick="mostrarSeccion('experiencia', this)"><i class="fas fa-briefcase"></i> Experiencia</a>
            </span>
            {% endif %}

            {% if perfil.mostrar_productos_laborales %}
            <span id="nav-laborales">
                <a class="nav-link" onclick="mostrarSeccion('productos_laborales', this)"><i class="fas fa-hammer"></i> Productos Laborales</a>
            </span>
            {% endif %}

            {% if perfil.mostrar_reconocimientos %}
            <span id="nav-reconocimientos">
                <a class="nav-link" onclick="mostrarSeccion('reconocimientos', this)"><i class="fas fa-award"></i> Reconocimientos</a>
            </span>
            {% endif %}

            {% if perfil.mostrar_cursos %}
            <span id="nav-cursos">
                <a class="nav-link" onclick="mostrarSeccion('cursos', this)"><i class="fas fa-chalkboard-teacher"></i> Cursos Realizados</a>
            </span>
            {% endif %}
        </div>

        <button class="btn-config-menu" data-bs-toggle="modal" data-bs-target="#webConfigModal">
            <i class="fas fa-sliders-h"></i> Configurar Menú
        </button>
    </nav>

    <main class="main-content">
        <section id="inicio" class="active-section">
            <div class="section-header"><h2>Información Personal</h2></div>
            <div class="info-card">
                <div class="icon-header"><i class="fas fa-user-circle"></i> Perfil Profesional</div>
                <p class="text-muted mb-0" style="text-align: justify; line-height: 1.8;">
                    {{ perfil.descripcionperfil|default:"Sin descripción." }}
                </p>
                {% if perfil.sitioweb %}
                <div class="mt-3">
                    <i class="fas fa-globe text-primary"></i> <a href="{{ perfil.sitioweb }}" target="_blank">{{ perfil.sitioweb }}</a>
                </div>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="info-card h-100">
                        <div class="icon-header"><i class="fas fa-id-card"></i> Datos Personales</div>
                        <div class="mb-2"><span class="info-label">Cédula:</span> <span class="info-value">{{ perfil.numerocedula }}</span></div>
                        <div class="mb-2"><span class="info-label">Nacimiento:</span> <span class="info-value">{{ perfil.fechanacimiento }}</span></div>
                        <div class="mb-2"><span class="info-label">Nacionalidad:</span> <span class="info-value">{{ perfil.nacionalidad|default:"Ecuatoriana" }}</span></div>
                        <div class="mb-2"><span class="info-label">Sexo:</span> <span class="info-value">{{ perfil.get_sexo_display }}</span></div>
                        <div class="mb-2"><span class="info-label">Estado Civil:</span> <span class="info-value">{{ perfil.estadocivil }}</span></div>
                        {% if perfil.licenciaconducir %}
                        <div class="mb-2"><span class="info-label">Licencia:</span> <span class="info-value">{{ perfil.licenciaconducir }}</span></div>
                        {% else %}
                        <div class="mb-2"><span class="info-label">Licencia:</span> <span class="info-value text-muted">No registrada</span></div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-card h-100">
                        <div class="icon-header"><i class="fas fa-map-marker-alt"></i> Ubicación y Contacto</div>
                        <div class="mb-3">
                            <span class="info-label"><i class="fas fa-mobile-alt"></i> Celular:</span> 
                            <span class="info-value">{{ perfil.telefonofijo }}</span>
                        </div>
                        {% if perfil.telefonoconvencional %}
                        <div class="mb-3">
                            <span class="info-label"><i class="fas fa-phone"></i> Convencional:</span> 
                            <span class="info-value">{{ perfil.telefonoconvencional }}</span>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <span class="info-label"><i class="fas fa-envelope"></i> Email:</span>
                            <span class="info-value">andy@ejemplo.com</span>
                        </div>
                        <hr class="text-muted">
                        <div class="mb-2">
                            <span class="info-label"><i class="fas fa-home"></i> Domicilio:</span> 
                            <span class="info-value">{{ perfil.direcciondomiciliaria }}</span>
                        </div>
                        {% if perfil.direcciontrabajo %}
                        <div class="mb-2">
                            <span class="info-label"><i class="fas fa-briefcase"></i> Trabajo:</span> 
                            <span class="info-value">{{ perfil.direcciontrabajo }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <section id="productos_academicos">
            <div class="section-header"><h2>Productos Académicos</h2></div>
            <div class="info-card">
                {% for prod in productos_academicos %}
                <div class="recurso-item">
                    <span class="recurso-titulo">
                        <i class="fas fa-book me-2 text-primary"></i> {{ prod.nombrerecurso }}
                    </span>
                    <p class="mb-1 text-muted small"><i class="fas fa-tag"></i> {{ prod.clasificador }}</p>
                    <p class="mb-0">{{ prod.descripcion }}</p>
                </div>
                {% empty %}
                <p class="text-center text-muted">No hay productos académicos registrados.</p>
                {% endfor %}
            </div>
        </section>

        <section id="experiencia">
            <div class="section-header"><h2>Experiencia Laboral</h2></div>
            <div class="info-card">
                {% for exp in experiencias %}
                    <div class="exp-item border-start border-3 border-primary ps-3 mb-4 pb-3" style="border-bottom: 1px dashed #eee;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="fw-bold mb-0 text-dark">{{ exp.cargodesempenado }}</h5>
                                <div class="text-primary fw-bold mb-1">
                                    {{ exp.nombrempresa }} 
                                    {% if exp.lugarempresa %}<span class="text-muted small fw-normal">| {{ exp.lugarempresa }}</span>{% endif %}
                                </div>
                            </div>
                            <span class="badge bg-light text-dark border">
                                <i class="far fa-calendar-alt"></i> {{ exp.fechainiciogestion|date:"M Y" }} - 
                                {% if exp.fechafingestion %}{{ exp.fechafingestion|date:"M Y" }}{% else %}Presente{% endif %}
                            </span>
                        </div>
                        <p class="mb-2 text-secondary mt-2">{{ exp.descripcionfunciones }}</p>
                        <div class="bg-light p-2 rounded mt-2 small text-muted">
                            <i class="fas fa-info-circle text-primary"></i> <strong>Referencia:</strong>
                            {% if exp.nombrecontactoempresarial %}{{ exp.nombrecontactoempresarial }}{% endif %}
                            {% if exp.telefonocontactoempresarial %} ({{ exp.telefonocontactoempresarial }}){% endif %}
                            {% if exp.emailempresa %} - {{ exp.emailempresa }}{% endif %}
                            {% if exp.sitiowebempresa %} 
                                <br><a href="{{ exp.sitiowebempresa }}" target="_blank" class="text-decoration-none"><i class="fas fa-link"></i> Web Empresa</a>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <p class="text-center text-muted">No hay experiencia registrada visible.</p>
                {% endfor %}
            </div>
        </section>

        <section id="productos_laborales">
            <div class="section-header"><h2>Productos Laborales</h2></div>
            <div class="info-card">
                {% for prod in productos_laborales %}
                <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                    <div class="bg-success text-white rounded p-3 me-3"><i class="fas fa-hammer fa-lg"></i></div>
                    <div>
                        <h5 class="mb-0 fw-bold">{{ prod.nombreproducto }}</h5>
                        <p class="text-muted mb-1">{{ prod.descripcion }}</p>
                        <small class="text-secondary"><i class="far fa-calendar-alt"></i> {{ prod.fechaproducto|date:"d M Y" }}</small>
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-muted">No hay productos laborales registrados.</p>
                {% endfor %}
            </div>
        </section>

        <section id="reconocimientos">
            <div class="section-header"><h2>Cursos y Certificaciones</h2></div>
            <div class="row">
                {% for rec in reconocimientos %}
                    <div class="col-md-6 mb-4">
                        <div class="info-card h-100 position-relative p-4 border-0 shadow-sm">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary rounded-pill">{{ rec.tiporeconocimiento }}</span>
                                <small class="text-muted"><i class="far fa-calendar"></i> {{ rec.fechareconocimiento|date:"M Y" }}</small>
                            </div>
                            <h5 class="fw-bold text-dark mb-1">{{ rec.descripcionreconocimiento }}</h5>
                            <p class="text-primary fw-bold mb-2">{{ rec.entidadpatrocinadora }}</p>
                            {% if rec.rutacertificado %}
                            <button class="btn btn-outline-dark btn-sm w-100 mt-3" type="button" data-bs-toggle="modal" data-bs-target="#certificadoModal" data-bs-img="{{ rec.rutacertificado.url }}">
                                <i class="fas fa-eye"></i> Ver Credencial
                            </button>
                            <div class="pdf-visible-content"><img src="{{ rec.rutacertificado.url }}" class="cert-img-pdf" alt="Certificado"></div>
                            {% endif %}
                            {% if rec.nombrecontactoauspicia or rec.telefonocontactoauspicia %}
                            <div class="mt-3 pt-2 border-top small text-muted">
                                <i class="fas fa-info-circle"></i> 
                                {{ rec.nombrecontactoauspicia|default:"" }} 
                                {% if rec.telefonocontactoauspicia %}({{ rec.telefonocontactoauspicia }}){% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12"><p class="text-center text-muted">No hay reconocimientos visibles.</p></div>
                {% endfor %}
            </div>
        </section>

        <section id="cursos">
            <div class="section-header"><h2>Cursos Realizados</h2></div>
            <div class="info-card">
                {% for cur in cursos %}
                    <div class="mb-4 pb-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-start flex-wrap">
                            <div>
                                <h5 class="fw-bold mb-1 text-dark">{{ cur.nombrecurso }}</h5>
                                <div class="text-primary fw-bold">
                                    {{ cur.entidadpatrocinadora }}
                                    <span class="badge bg-warning text-dark ms-2">{{ cur.totalhoras }} Horas</span>
                                </div>
                            </div>
                            <small class="text-muted mt-1">
                                <i class="far fa-calendar-alt"></i> {{ cur.fechainicio|date:"d M Y" }} - {{ cur.fechafin|date:"d M Y" }}
                            </small>
                        </div>
                        <p class="mb-2 text-secondary mt-2 small fst-italic">{{ cur.descripcioncurso }}</p>
                        <div class="bg-light p-2 rounded mt-2 small text-muted d-flex justify-content-between align-items-center flex-wrap">
                            <div>
                                <i class="fas fa-user-tie text-primary"></i> 
                                {{ cur.nombrecontactoauspicia|default:"--" }} 
                                {% if cur.telefonocontactoauspicia %}({{ cur.telefonocontactoauspicia }}){% endif %}
                            </div>
                            {% if cur.rutacertificado %}
                            <button class="btn btn-sm btn-outline-primary mt-2 mt-md-0" data-bs-toggle="modal" data-bs-target="#certificadoModal" data-bs-img="{{ cur.rutacertificado.url }}">
                                <i class="fas fa-file-certificate"></i> Ver Certificado
                            </button>
                            <div class="pdf-visible-content"><img src="{{ cur.rutacertificado.url }}" class="cert-img-pdf" alt="Certificado Curso"></div>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted text-center">No hay cursos registrados visibles.</p>
                {% endfor %}
            </div>
        </section>
    </main>

    <div class="modal fade" id="webConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary">Activar/Desactivar Secciones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Selecciona qué quieres ver en pantalla:</p>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="swGarage" checked onchange="toggleWeb('btnGarageTop', this.checked)"><label class="form-check-label">Ver Garage</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="swProds" checked onchange="toggleWeb('nav-productos', this.checked)"><label class="form-check-label">Ver Productos Académicos</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="swExp" checked onchange="toggleWeb('nav-experiencia', this.checked)"><label class="form-check-label">Ver Experiencia</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="swLaboral" checked onchange="toggleWeb('nav-laborales', this.checked)"><label class="form-check-label">Ver Productos Laborales</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="swRec" checked onchange="toggleWeb('nav-reconocimientos', this.checked)"><label class="form-check-label">Ver Reconocimientos</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="swCursos" checked onchange="toggleWeb('nav-cursos', this.checked)"><label class="form-check-label">Ver Cursos</label></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary w-100 rounded-pill" data-bs-dismiss="modal">Listo</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="pdfConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-danger"><i class="fas fa-file-pdf"></i> Configurar PDF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Elige las secciones para incluir en el PDF:</p>
                    <div class="form-check form-switch mb-2"><input class="form-check-input pdf-check" type="checkbox" checked data-target="productos_academicos"><label class="form-check-label">Productos Académicos</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input pdf-check" type="checkbox" checked data-target="experiencia"><label class="form-check-label">Experiencia Laboral</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input pdf-check" type="checkbox" checked data-target="productos_laborales"><label class="form-check-label">Productos Laborales</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input pdf-check" type="checkbox" checked data-target="reconocimientos"><label class="form-check-label">Reconocimientos</label></div>
                    <div class="form-check form-switch mb-2"><input class="form-check-input pdf-check" type="checkbox" checked data-target="cursos"><label class="form-check-label">Cursos</label></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-danger w-100 rounded-pill" onclick="generarPDFManaged()">Descargar PDF</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="garageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header text-white" style="background: var(--garage-color);">
                    <h5 class="modal-title fw-bold"><i class="fas fa-store"></i> Garage de {{ perfil.nombres }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light p-4">
                    <div class="row">
                        {% for prod in productos_garage %}
                        <div class="col-md-4 mb-4">
                            <div class="product-card position-relative">
                                <span class="badge-estado {% if prod.estadoproducto == 'Bueno' %}bg-bueno{% else %}bg-regular{% endif %}">
                                    {{ prod.estadoproducto }}
                                </span>

                                <img src="{% if prod.imagen %}{{ prod.imagen.url }}{% else %}{% static 'ventilador.jpg' %}{% endif %}" class="product-img" alt="{{ prod.nombreproducto }}" onerror="this.src='{% static 'ventilador.jpg' %}'">
                                
                                <h5 class="fw-bold text-dark mt-2">{{ prod.nombreproducto }}</h5>
                                <p class="text-muted small">{{ prod.descripcion|truncatechars:50 }}</p>
                                <div class="product-price">${{ prod.valordelbien }}</div>
                                <button class="btn btn-warning w-100 fw-bold rounded-pill text-white" onclick="alert('¡{{ prod.nombreproducto|escapejs }} agregado al carrito!')"><i class="fas fa-cart-plus"></i> Comprar</button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <h4 class="text-muted">Este garage está vacío para este perfil.</h4>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="certificadoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body text-center position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                    <img id="imagenModal" src="" class="img-fluid rounded shadow-lg" alt="Certificado">
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.toggleWeb = function(elementId, isChecked) {
                const el = document.getElementById(elementId);
                if(el) {
                    if(isChecked) el.classList.remove('d-none-web');
                    else el.classList.add('d-none-web');
                }
            };

            window.mostrarSeccion = function(idSeccion, elementoBtn) {
                document.querySelectorAll('section').forEach(sec => sec.classList.remove('active-section'));
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
                
                const seccion = document.getElementById(idSeccion);
                if(seccion) seccion.classList.add('active-section');
                if(elementoBtn) elementoBtn.classList.add('active');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const certModal = document.getElementById('certificadoModal');
            if (certModal) {
                certModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const imagenSrc = button.getAttribute('data-bs-img');
                    const modalImg = certModal.querySelector('#imagenModal');
                    if(modalImg) modalImg.src = imagenSrc;
                });
            }

            window.generarPDFManaged = function() {
                const modalEl = document.getElementById('pdfConfigModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();

                const element = document.getElementById('body-cv');
                const btn = document.querySelector('.btn-pdf');
                const originalText = '<i class="fas fa-file-pdf"></i> PDF';
                
                if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
                document.body.classList.add('generating-pdf');

                const checks = document.querySelectorAll('.pdf-check');
                checks.forEach(chk => {
                    const target = document.getElementById(chk.getAttribute('data-target'));
                    if(target) {
                        if(!chk.checked) target.classList.add('d-none-pdf');
                        else target.style.display = 'block'; 
                    }
                });

                const opt = {
                    margin: 0,
                    filename: 'CV_{{ perfil.nombres }}.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                setTimeout(() => {
                    html2pdf().set(opt).from(element).save()
                    .then(() => { limpiarTodo(btn, originalText); })
                    .catch((err) => { 
                        console.error(err); 
                        limpiarTodo(btn, originalText); 
                    });
                }, 800);
            };

            function limpiarTodo(btn, originalText) {
                document.body.classList.remove('generating-pdf');
                if(btn) btn.innerHTML = originalText;
                document.querySelectorAll('section').forEach(sec => {
                    sec.style.display = ''; 
                    sec.classList.remove('d-none-pdf');
                });
            }
        });
    </script>
</body>
</html>